<!DOCTYPE html>
<html>
  <head>
    <title>Xavier Van de Woestyne</title>
		<link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,400italic,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
<link href='../css/app.min.css' rel='stylesheet' type='text/css'>

		<link rel="stylesheet" href="../css/default.css">
    <meta charset="utf-8">
    <meta name='keywords' content='ocaml,type,fant„¥me,typage,programmation'>
		<script src="../js/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
		<div id="content">
			<div id="header">
				<h1>Les types fant√¥mes</h1>
				<h2>introduction avec OCaml</h2>
			</div>
			<div class="center headmenu">
        <a href="../list.html#Encore-une-lecture?" title="Bonne lecture?">Retour √† la liste</a>
				<a href="../index.html#Pourquoi-ne-pas-laisser-un-petit-commentaire?!" title="Il y a des commentaires en bas !!!">Retour √† l'accueil</a>
			</div>
			<div id="article-content">
				<blockquote>
<p>Cet article n'a pas grand-chose d'in√©dit. Il s'agit d'une occasion de pr√©senter une utilisation amusante d'un syst√®me de types au travers du langage OCaml pour r√©pondre √† une probl√©matique pouvant √™tre tr√®s co√ªteuse. Il est important de noter que <strong>cet article utilise au moins OCaml 4</strong>.</p>
</blockquote>
<h2 id="avant-propos">Avant-propos</h2>
<p>Pour une bonne compr√©hension de cet article, il est requis d'avoir une connaissance sommaire du langage OCaml (conna√Ætre les types variants / disjonctions, les modules et les types abstraits et, <em>√©videmment</em>, √™tre √† l'aise avec la syntaxe de OCaml). Avant de nous lancer dans le <em>vif</em> du sujet, nous commencerons par √©voquer un cas pratique o√π les types fant√¥mes auraient √©t√© utiles. Ensuite nous rappellerons quelques petites choses relatives √† OCaml, et nous d√©finirons <em>enfin</em> ce que sont les types fant√¥mes. En fin d'article, quelques cas pratiques seront pr√©sent√©s.</p>
<h3 id="mars-climate-orbiter">Mars Climate Orbiter</h3>
<p>Le 23 Mars 1999, la sonde &quot;<em>Mars Climate Orbiter</em>&quot; tente d'effectuer sa manoeuvre d'insertion autour de l'orbite de Mars via une proc√©dure enti√®rement automatis√©e. Durant cette d√©marche, la radio devait imp√©rativement √™tre coup√©e durant le temps o√π la sonde se trouverait derri√®re Mars. Le lendemain, la sonde n'avait toujours pas √©mis de signaux radio. Elle est consid√©r√©e comme perdue. La sonde avait suivi une trajectoire beaucoup trop basse (pr√®s de 140 km de dessous de ce qui √©tait pr√©vu) par rapport √† sa vitesse et s'est donc probablement transform√©e en boule de feu. Une commission d'enqu√™te r√©v√®lera vite la raison de cette erreur de trajectoire : la sonde recevait la pouss√©e de ses micropropulseurs en <strong>Livres-force.seconde</strong> (une unit√© de mesure anglo-saxonne) et le logiciel interne de la sonde traitait ces donn√©es comme s'il s'agissait de <strong>Newton.seconde</strong>. Cette non-concordance de donn√©es a entra√Æn√© des modifications de la trajectoire de la sonde, l'amenant √† sa destruction et faisant perdre √† la NASA pr√®s de 125 millions de dollars.</p>
<p>Cette erreur a des cons√©quences impressionnantes. Et m√™me si l'on pourrait s'interroger sur la mani√®re dont la NASA a pu commettre une erreur aussi grande, elle est extr√™mement difficile √† d√©celer car elle ne provoque aucune erreur de compilation, toutes les donn√©es √©tant trait√©es de mani√®re uniforme, comme des flottants. L'enjeu de cet article est de pr√©senter une mani√®re √©l√©gante de pr√©venir ce genre d'erreur √† la compilation.</p>
<h4 id="limite-des-variants-classiques">Limite des variants classiques</h4>
<p>Limitons notre probl√®me √† la distinction entre des <strong>centim√®tres</strong> et des <strong>kilom√®tres</strong>, et comme fonctionnalit√©s, des conversions :</p>
<ul>
<li><code>cm_to_km</code></li>
<li><code>km_to_cm</code></li>
</ul>
<p>Na√Øvement, lorsque j'ai √©t√© amen√© √† lire le probl√®me de typage soulev√© par la sonde <em>Mars Climate Orbiter</em>, et de mani√®re plus g√©n√©rale √† la repr√©sentation d'unit√©s de mesure, j'ai pens√© √† la d√©finition d'une disjonction s√©parant les kilom√®tres des centim√®tres. Avec, par exemple, ceci comme impl√©mentation :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">exception</span> <span class="dt">IllegalMeasureData</span>
<span class="kw">type</span> measure = 
| <span class="dt">Cm</span> <span class="kw">of</span> float 
| <span class="dt">Km</span> <span class="kw">of</span> float 

<span class="kw">let</span> cm x = <span class="dt">Cm</span> x
<span class="kw">let</span> km x = <span class="dt">Km</span> x

<span class="kw">let</span> cm_to_km = <span class="kw">function</span> 
  | <span class="dt">Cm</span> x -&gt; <span class="dt">Km</span> (x *. <span class="fl">100000.0</span>)
  | _ -&gt; raise <span class="dt">IllegalMeasureData</span>

<span class="kw">let</span> km_to_cm = <span class="kw">function</span> 
  | <span class="dt">Km</span> x -&gt; <span class="dt">Cm</span> (x /. <span class="fl">100000.0</span>)
  | _ -&gt; raise <span class="dt">IllegalMeasureData</span></code></pre>
<p>Cette mani√®re de proc√©der semble correcte, et si je tente une conversion sur une valeur invalide, par exemple <code>let test = km_to_cm (cm 10.0)</code>, mon code renverra une erreur <code>IllegalMeasureData</code>, et ce √† la compilation. Cependant, si l'erreur se d√©clenche, c'est uniquement parce que la variable <em>test</em> √©value directement l'expression <code>km_to_cm (cm 10.0)</code>. Voyons ce qu'il se passe si nous essayons de compiler notre code avec cette d√©claration : <code>let test () = km_to_cm (cm 10.0)</code>. Cette fois-ci, la compilation fonctionne.</p>
<p>Cela prouve que les erreurs ne sont pas v√©rifi√©es √† la compilation. Car les fonctions <code>km_to_cm</code> et <code>cm_to_km</code> ont le type <code>measure -&gt; measure</code>. Et donc une incoh√©rence telle que passer une valeur en kilom√®tres √† la fonction <code>cm_to_km</code> ne peut √™tre d√©tect√©e r√©ellement √† la compilation.</p>
<h2 id="impl√©mentation-des-types-fant√¥mes">Impl√©mentation des types fant√¥mes</h2>
<p>Nous avons vu que les variants classiques ne permettent pas assez de v√©rification pour distinguer des donn√©es au sein d'un m√™me type √† la compilation (car oui, il serait possible de distinguer chaque unit√© de mesure dans des types diff√©rents, de cette mani√®re :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> Measure =
<span class="kw">struct</span>
  <span class="kw">type</span> km = <span class="dt">Km</span> <span class="kw">of</span> float
  <span class="kw">type</span> cm = <span class="dt">Cm</span> <span class="kw">of</span> float
<span class="kw">end</span></code></pre>
<p>Cependant ce n'est absolument pas confortable et ce n'est pas r√©ellement l'int√©r√™t de cet article). Donc avant de d√©finir et de proposer une impl√©mentation, nous allons devoir (re)voir quelques outils en relation avec le langage OCaml.</p>
<h3 id="les-variants-polymorphiques">Les variants polymorphiques</h3>
<p>Bien que tr√®s utiles dans le <em>design</em> d'application, les variants poss√®dent des limitations. Par exemple, le fait qu'un type Somme ne puisse √™tre enrichi de constructeurs (ce qui n'est plus tout-√†-fait vrai depuis <em>OCaml 4.02.0</em>), mais aussi le fait qu'un constructeur ne puisse appartenir qu'√† un seul type. Les variants polymorphes s'extraient de ces deux contraintes et peuvent m√™me √™tre d√©clar√©s √† la vol√©e, sans appartenir √† un type pr√©d√©fini. La d√©finition d'un constructeur polymorphe est identique √† celle d'un constructeur normal (il commence par une majuscule) mais est pr√©c√©d√©e du caract√®re <em>`</em>.</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"># <span class="kw">let</span> a = <span class="dt">`Truc</span> <span class="dv">9</span>;;
<span class="kw">val</span> a : [&gt; <span class="dt">`Truc</span> <span class="kw">of</span> <span class="dt">int</span> ] = <span class="dt">`Truc</span> <span class="dv">9</span>
# <span class="kw">let</span> b = <span class="dt">`Truc</span> <span class="st">&quot;test&quot;</span>;;
<span class="kw">val</span> b : [&gt; <span class="dt">`Truc</span> <span class="kw">of</span> <span class="dt">string</span> ] = <span class="dt">`Truc</span> <span class="st">&quot;test&quot;</span></code></pre>
<p>Comme vous pouvez le voir, je me suis servi deux fois du constructeur <em>`Truc</em> en lui donnant des arguments √† types diff√©rents et sans l'avoir d√©clar√©.</p>
<h4 id="borne-sup√©rieure-et-inf√©rieure">Borne sup√©rieure et inf√©rieure</h4>
<p>L'usage des variants polymorphes introduit une notation de retour diff√©rente de celle des variants normaux. Par exemple :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> to_int = <span class="kw">function</span> 
  | <span class="dt">`Integer</span> x -&gt; x 
  | <span class="dt">`Float</span> x -&gt; int_of_float x;;

<span class="kw">let</span> to_int&#39; = <span class="kw">function</span> 
  | <span class="dt">`Integer</span> x -&gt; x 
  | <span class="dt">`Float</span> x -&gt; int_of_float x
  | _ -&gt; <span class="dv">0</span>

# <span class="kw">val</span> to_int : [&lt; <span class="dt">`Float</span> <span class="kw">of</span> float | <span class="dt">`Integer</span> <span class="kw">of</span> <span class="dt">int</span> ] -&gt; <span class="dt">int</span> = &lt;<span class="kw">fun</span>&gt;
# <span class="kw">val</span> to_int&#39; :[&gt; <span class="dt">`Float</span> <span class="kw">of</span> float | <span class="dt">`Integer</span> <span class="kw">of</span> <span class="dt">int</span> ] -&gt; <span class="dt">int</span> = &lt;<span class="kw">fun</span>&gt;</code></pre>
<p>Ce que l'on remarque c'est que le chevron varie. Dans le cas o√π la fonction n'√©value <em>que</em> les constructeurs <em>Integer</em> et <em>Float</em>, le chevron est <code>&lt;</code>. Si la fonction peut potentiellement √©valuer autre chose, le chevron est <code>&gt;</code>.</p>
<ul>
<li><code>[&lt; K]</code> indique que le type ne peut contenir que K</li>
<li><code>[&gt; K]</code> indique que le type peut contenir au moins K</li>
</ul>
<p>Nous verrons que cette restriction sur les entr√©es permettra d'affiner le typage de fonctions.</p>
<h4 id="restriction-sur-les-variants-polymorphes">Restriction sur les variants polymorphes</h4>
<p>Les variants polymorphes ne permettent tout de m√™me pas de faire des choses comme :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> truc = <span class="kw">function</span>
  | <span class="dt">`A</span> -&gt; <span class="dv">0</span>
  | <span class="dt">`A</span> x -&gt; x </code></pre>
<p>Au sein d'une <em>m√™me</em> fonction, on ne peut pas utiliser un <em>m√™me</em> variant avec des arguments diff√©rents. De mon point de vue, c'est plus logique que limitant. Mais rien n'emp√™che de faire deux fonctions qui, elles, utilisent des variants polymorphes √† arguments variables.</p>
<h4 id="nommer-les-variants-polymorphes">Nommer les variants polymorphes</h4>
<p>Bien que l'on puisse les nommer √† l'usage, il peut parfois √™tre confortable de sp√©cifier des variants polymorphes dans un type nomm√© (ne serait-ce que pour le confort de la r√©utilisation). Leur syntaxe (que nous verrons un peu plus bas) est assez proche des d√©clarations de variants classiques, cependant, <strong>on ne peut pas</strong> sp√©cifier la borne dans la d√©finition de type de variants polymorphes. Ce qui est parfaitement logique car un type ouvert (donc born√©) ne correspond pas √† un seul type mais √† une collection de types.</p>
<p>A la diff√©rence des variants normaux, les variants polymorphes se d√©clarent dans une liste dont les diff√©rentes √©num√©rations sont s√©par√©es par un pipe. Par exemple :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> poly_color = [<span class="dt">`Red</span> <span class="kw">of</span> <span class="dt">int</span> | <span class="dt">`Green</span> <span class="kw">of</span> <span class="dt">int</span> | <span class="dt">`Blue</span> <span class="kw">of</span> <span class="dt">int</span>]</code></pre>
<p>Il est √©videmment possible d'utiliser les variants polymorphes dans la d√©claration de variants normaux, par exemple :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> color_list =
| <span class="dt">Empty</span>
| <span class="dt">Cons</span> <span class="kw">of</span> ( [<span class="dt">`Red</span> <span class="kw">of</span> <span class="dt">int</span> | <span class="dt">`Green</span> <span class="kw">of</span> <span class="dt">int</span> | <span class="dt">`Blue</span> <span class="kw">of</span> <span class="dt">int</span>]  *  color_list)</code></pre>
<p>Par contre, m√™me si dans les d√©finitions de types on ne peut pas sp√©cifier de borne, on peut le faire dans les contraintes de types des fonctions. Et c'est gr√¢ce √† cette autorisation que nous utiliserons les types fant√¥mes avec des variants polymorphes.</p>
<h4 id="conclusion-sur-les-variants-polymorphes">Conclusion sur les variants polymorphes</h4>
<p>Les variants polymorphes permettent plus de flexibilit√© que les variants classiques. Cependant, ils ont aussi leurs petits soucis :</p>
<ul>
<li>Ils entra√Ænent des petites pertes d'efficacit√© (mais √ßa, c'est superflu)</li>
<li>Ils diminuent le nombre de v√©rifications statiques</li>
<li>Ils introduisent des erreurs de typage tr√®s complexes</li>
</ul>
<p>En conclusion, j'ai introduit les variants polymorphes car nous nous en servirons pour les types fant√¥mes, cependant il est conseill√© de ne les utiliser qu'en cas de r√©el besoin.</p>
<h3 id="a-lassaut-des-types-fant√¥mes">A l'assaut des types fant√¥mes</h3>
<p>Apr√®s une tr√®s longue introduction et une l√©g√®re mise en place des pr√©-requis, nous allons expliquer ce que sont les types fant√¥mes. Ensuite, nous √©voquerons quelques cas de figure.</p>
<blockquote>
<p>Concr√®tement, un type fant√¥me n'est rien de plus qu'un type abstrait param√©tr√© dont au moins un des param√®tres n'est pr√©sent que pour donner des informations sur comment utiliser ce type.</p>
</blockquote>
<p>Concr√®tement, voici un exemple de type fant√¥me : <code>type 'a t = float</code>. Si le type n'est pas abstrait, le type t sera identique √† un flottant normal. Par contre, si le type est abstrait (donc que son impl√©mentation est cach√©e), le compilateur le diff√©renciera d'un type flottant.</p>
<p>Avec cette pi√®tre d√©finition on ne peut pas aller tr√®s loin. Voyons dans les sections suivantes quelques cas de figure pr√©cis d'utilisation des types fant√¥mes.</p>
<h2 id="distinguer-des-unit√©s-de-mesure">Distinguer des unit√©s de mesure</h2>
<p>Si cet article a √©t√© introduit via une erreur d√ªe √† des unit√©s de mesure, ce n'est pas tout √† fait innocent. Nous avions vu que via des variants classiques, il n'√©tait a priori pas possible (en gardant un confort d'utilisation) de distinguer √† la compilation des unit√©s de mesures. Nous allons voir qu'au moyen des types fant√¥mes, c'est tr√®s simple.</p>
<p>Par souci de lisibilit√©, j'utiliserai des sous-modules. Cependant, ce n'est absolument pas obligatoire.</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> Measure :
<span class="kw">sig</span> 
  <span class="kw">type</span> &#39;a t
  <span class="kw">val</span> km : float -&gt; [<span class="dt">`Km</span>] t 
  <span class="kw">val</span> cm : float -&gt; [<span class="dt">`Cm</span>] t
<span class="kw">end</span> = <span class="kw">struct</span>
  <span class="kw">type</span> &#39;a t = float
  <span class="kw">let</span> km f = f
  <span class="kw">let</span> cm f = f
<span class="kw">end</span></code></pre>
<p>Ce module produit offre des fonctions qui produisent des valeurs de type <code>Measure.t</code>, mais ces donn√©es sont d√©cor√©es. Les kilom√®tres et les centim√®tres ont donc une diff√©rence structurelle. Imaginons que nous enrichissions notre module d'une fonction addition, dont le prototype serait : <code>'a t -&gt; 'a t -&gt; 'a t</code>, et le code ne serait qu'un appel de <code>(+.)</code> (l'addition flottante) :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> Measure :
<span class="kw">sig</span> 
  <span class="kw">type</span> &#39;a t
  <span class="kw">val</span> km : float -&gt; [<span class="dt">`Km</span>] t 
  <span class="kw">val</span> cm : float -&gt; [<span class="dt">`Cm</span>] t
  <span class="kw">val</span> ( + ) : &#39;a t -&gt; &#39;a t -&gt; &#39;a t
<span class="kw">end</span> = <span class="kw">struct</span>
  <span class="kw">type</span> &#39;a t = float
  <span class="kw">let</span> km f = f
  <span class="kw">let</span> cm f = f
  <span class="kw">let</span> ( + ) =  ( +. )
<span class="kw">end</span></code></pre>
<p>Que se passe t-il si je fais l'addition de centim√®tres et de kilom√®tres (cr√©√©s au moyen des fonctions <code>km</code> et <code>cm</code>) ? Le code plantera √† la compilation car il est indiqu√© dans le prototype de la fonction que le param√®tre du type t (<code>'a</code>) doit imp√©rativement √™tre le m√™me pour les deux membres de l'addition. Nous avons donc une distinction, au niveau du typeur, des unit√©s de mesure, pourtant repr√©sent√©es via des entiers.</p>
<p>Retournons √† notre exemple de conversion, cette fois enrichissons notre module des fonctions de conversion :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> Measure :
<span class="kw">sig</span> 
  <span class="kw">type</span> &#39;a t
  <span class="kw">val</span> km : float -&gt; [<span class="dt">`Km</span>] t 
  <span class="kw">val</span> cm : float -&gt; [<span class="dt">`Cm</span>] t
  <span class="kw">val</span> ( + ) : &#39;a t -&gt; &#39;a t -&gt; &#39;a t
  <span class="kw">val</span> km_of_cm : [<span class="dt">`Cm</span>] t -&gt; [<span class="dt">`Km</span>] t  
  <span class="kw">val</span> cm_of_km : [<span class="dt">`Km</span>] t -&gt; [<span class="dt">`Cm</span>] t
<span class="kw">end</span> = <span class="kw">struct</span>
  <span class="kw">type</span> &#39;a t = float
  <span class="kw">let</span> km f = f
  <span class="kw">let</span> cm f = f
  <span class="kw">let</span> ( + ) = ( +. )
  <span class="kw">let</span> km_of_cm f = f /. <span class="fl">10000.0</span>
  <span class="kw">let</span> cm_of_km f = f *. <span class="fl">10000.0</span>
<span class="kw">end</span></code></pre>
<p>Cette fois-ci, le typeur refusera formellement des conversions improbables. Dans cet exemple, j'aurais pu utiliser autre chose que des variants polymorphes pour distinguer mes centim√®tres de mes kilom√®tres. Cependant, nous allons voir qu'il est possible de se servir des bornes pour affiner le typeur. Et le fait de ne pas devoir les d√©clarer les rend agr√©able √† utiliser.</p>
<h2 id="du-html-valide">Du HTML valide</h2>
<p>Dans plusieurs frameworks de d√©veloppement web, il arrive que l'on se serve de la syntaxe des fonctions du langage pour l'√©criture de HTML. C'est le cas, par exemple de <a href="http://yaws.hyber.org">Yaws</a>, un serveur web pour cr√©er des applications web en Erlang, qui se sert des tuples et des atomes de erlang pour repr√©senter du HTML. De m√™me que <a href="http://www.ocsigen.org">Ocsigen</a>, le framework de d√©veloppement web OCaml, qui propose, entre autres, une √©criture fonctionnelle. Il existe plusieurs int√©r√™ts √† cet usage, le premier √©tant le plus √©vident : c'est g√©n√©ralement beaucoup plus rapide √† √©crire !</p>
<blockquote>
<p>En effet, en HTML, beaucoup de balises doivent √™tre ferm√©es, les attributs doivent √™tre entre guillemets et li√©s par un √©gal, bref, √©norm√©ment de verbosit√©. (<a href="http://homepages.inf.ed.ac.uk/wadler/language.pdf">Une petite blague</a> trouv√©e sur le site de Philip Wadler)</p>
</blockquote>
<p>Dans un langage comme OCaml, le typage (et les types fant√¥mes) nous permettront d'encoder une partie du DTD du HTML pour ne permettre de cr√©er que des pages valides (selon le W3C) et donc amoindrir fortemment le flux de travail (ne devant plus passer par de la v√©rification avec les outils du W3C et sachant que si une page compile, c'est qu'elle est bonne). Un exemple classique : une balise <code>span</code> ne peut pas contenir de balise <code>div</code>. Et de mani√®re plus g√©n√©rale, aucune balise de type block ne peut √™tre contenue dans une balise de type inline.</p>
<h3 id="sous-typage-covariance-et-contravariance">Sous-typage, covariance et contravariance</h3>
<p>Les variants polymorphes introduisent une notion de sous-typage dans le langage OCaml. Concr√®tement, un premier type (d√©fini par des constructeurs polymorphes) ferm√© est un sous-type d'un autre type (d√©fini lui aussi par des constructeurs polymorphes) ferm√©, si tous les constructeurs du premier sont inclus dans les constructeurs du second.</p>
<p>En OCaml, le fait de consid√©rer un sous-type comme son type parent est possible au moyen d'une coersion, via l'op√©rateur <code>:&gt;</code>, pour diminuer le sous-type dans son sur-type. Concr√®tement, la coersion d'une valeur d'un type <code>t1</code> en type <code>t2</code> s'√©crit de cette mani√®re : <code>valeur : t1 :&gt; t2</code>. Le sous-typage des variants polymorphes introduit des r√®gles particuli√®res dans le cas des fonctions :</p>
<ul>
<li>Le type de retour d'une fonction suit la m√™me direction de sous-typage que le type fonctionnel, on dit qu'il est <strong>covariant</strong> (et not√© +)</li>
<li>Le type du param√®tre va dans le sens inverse, on dit qu'il est <strong>contravariant</strong> (et not√© -).</li>
</ul>
<p>Le compilateur de OCaml peut d√©terminer si un type est un sous-type d'un autre pour les types qu'il conna√Æt. Il est donc impossible qu'il d√©duise le sous-typage des types abstraits. Pour permettre au compilateur de faire la relation de sous-typage, on annotera un type abstrait d'un + s'il est covariant et d'un - s'il est contravariant :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> (+&#39;a) t <span class="co">(* Type covariant *)</span>
<span class="kw">type</span> (-&#39;a) t <span class="co">(* Type contravariant *)</span></code></pre>
<p>Cette pr√©cision est importante car nous nous servirons de la covariance et de la contravariance pour produire des documents HTML statiquement typ√©s.</p>
<h3 id="organisation-par-les-types">Organisation par les types</h3>
<p>Pour produire un document HTML, il faut d'abord isoler les constituants d'un document HTML. Pour ma part, j'ai d√©cid√© de fragmenter les balises en trois cat√©gories :</p>
<ul>
<li>Le texte brut (pcdata)</li>
<li>Les balises feuilles (<code>&lt;br /&gt;</code>, <code>&lt;hr /&gt;</code>) par exemple</li>
<li>Les balises noeuds (des balises pouvant en contenir d'autres).</li>
</ul>
<p>Ces balises seront elles-m√™mes divis√©es en plusieurs sous-cat√©gories, par exemple les balises dites <em>inline</em> (comme <code>&lt;span&gt;</code>), qui ne peuvent pas contenir de balises dites <em>block</em> (comme <code>&lt;div&gt;</code> par exemple).</p>
<p>Je sugg√®re cette impl√©mentation :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> HTML : 
<span class="kw">sig</span> 
  <span class="kw">type</span> (+&#39;a) tag
<span class="kw">end</span> = <span class="kw">struct</span>
  <span class="kw">type</span> raw_tag = 
    | <span class="dt">Pcdata</span> <span class="kw">of</span> <span class="dt">string</span> 
    | <span class="dt">Leaf</span> <span class="kw">of</span> <span class="dt">string</span> 
    | <span class="dt">Node</span> <span class="kw">of</span> <span class="dt">string</span> * raw_tag <span class="dt">list</span> 
  <span class="kw">type</span> &#39;a tag = raw_tag
<span class="kw">end</span></code></pre>
<p>Le fait que les feuilles et les noeuds prennent des cha√Ænes de caract√®res dans leur signature permettra de parser une arborescence HTML typ√©e et d'en produire le HTML textuel correspondant.<br />Nous pouvons nous atteler √† la construction de balises, au moyen de fonctions.</p>
<h3 id="construction-de-balises">Construction de balises</h3>
<p>Les balises sont assez simples √† construire. Commen√ßons par la balise <code>Pcdata</code>, dont la principale contrainte est de ne pouvoir prendre qu'une cha√Æne de caract√®res :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">val</span> pcdata : <span class="dt">string</span> -&gt; [<span class="dt">`Pcdata</span>] tag
<span class="kw">let</span> pcdata x = <span class="dt">Pcdata</span> x</code></pre>
<p>L'impl√©mentation de <code>&lt;hr /&gt;</code> et <code>&lt;br /&gt;</code> est assez √©vidente, et ne demande pas de pr√©cisions :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">val</span> hr : [<span class="dt">`Hr</span>] tag
<span class="kw">val</span> br : [<span class="dt">`Br</span>] tag
<span class="kw">let</span> hr = <span class="dt">Leaf</span> <span class="st">&quot;hr&quot;</span>
<span class="kw">let</span> br = <span class="dt">Leaf</span> <span class="st">&quot;br&quot;</span></code></pre>
<p>Passons maintenant aux impl√©mentations les plus int√©ressantes. Une <code>&lt;div&gt;</code> peut a priori prendre n'importe quel type de balise (ce n'est pas tout-√†-fait vrai, mais nous partirons de ce principe pour l'exemple), son impl√©mentation est donc elle aussi assez facile :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">val</span> div : &#39;a tag <span class="dt">list</span> -&gt; [<span class="dt">`Div</span>] tag
<span class="kw">let</span> div children = <span class="dt">Node</span> (<span class="st">&quot;div&quot;</span>, children)</code></pre>
<p>Les <code>&lt;span&gt;</code> sont un peu diff√©rents car ces derniers ne peuvent contenir <strong>que</strong> des <code>&lt;span&gt;</code> ou des <code>Pcdata</code>. Il faut donc restreindre leur domaine d'entr√©e :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">val</span> span : [&lt; <span class="dt">`Span</span> | <span class="dt">`Pcdata</span> ] tag <span class="dt">list</span> -&gt; [<span class="dt">`Span</span>] tag
<span class="kw">let</span> span children = <span class="dt">Node</span> (<span class="st">&quot;span&quot;</span>, children)</code></pre>
<p>Cette fois, la d√©coration du type <code>tag</code> restreint les entr√©es √† seulement des donn√©es <code>&lt;span&gt;</code> ou des <code>Pcdata</code>. (Oui, la borne est sup√©rieure, donc on limite l'entr√©e √† ces deux types uniquement). Pour rappel, le code g√©n√©ral du module est :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> HTML : 
<span class="kw">sig</span> 
  <span class="kw">type</span> (+&#39;a) tag
  <span class="kw">val</span> pcdata : <span class="dt">string</span> -&gt; [<span class="dt">`Pcdata</span>] tag
  <span class="kw">val</span> hr : [&lt;<span class="dt">`Hr</span>] tag
  <span class="kw">val</span> br : [&lt;<span class="dt">`Br</span>] tag
  <span class="kw">val</span> div : &#39;a tag <span class="dt">list</span> -&gt; [<span class="dt">`Div</span>] tag
  <span class="kw">val</span> span : [&lt; <span class="dt">`Span</span> | <span class="dt">`Pcdata</span> ] tag <span class="dt">list</span> -&gt; [<span class="dt">`Span</span>] tag
<span class="kw">end</span> = <span class="kw">struct</span>
  <span class="kw">type</span> raw_tag = 
    | <span class="dt">Pcdata</span> <span class="kw">of</span> <span class="dt">string</span> 
    | <span class="dt">Leaf</span> <span class="kw">of</span> <span class="dt">string</span> 
    | <span class="dt">Node</span> <span class="kw">of</span> <span class="dt">string</span> * raw_tag <span class="dt">list</span> 
  <span class="kw">type</span> &#39;a tag = raw_tag
  <span class="kw">let</span> pcdata x = <span class="dt">Pcdata</span> x
  <span class="kw">let</span> hr = <span class="dt">Leaf</span> <span class="st">&quot;hr&quot;</span>
  <span class="kw">let</span> br = <span class="dt">Leaf</span> <span class="st">&quot;br&quot;</span>
  <span class="kw">let</span> div children = <span class="dt">Node</span> (<span class="st">&quot;div&quot;</span>, children)
  <span class="kw">let</span> span children = <span class="dt">Node</span> (<span class="st">&quot;span&quot;</span>, children) 
<span class="kw">end</span></code></pre>
<p>Je vous invite maintenant √† saisir quelques expressions pour tester notre code, par exemple : <code>HTML.(span [br])</code> qui devrait √©chouer, ou encore <code>HTML.(span [pcdata &quot;hello&quot;])</code>, qui devrait r√©ussir. Un autre exemple un peu plus long :</p>
<pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> <span class="ot">open</span> HTML <span class="kw">in</span>
  div [
    span [pcdata <span class="st">&quot;Hello world&quot;</span>];
    hr;
    span [pcdata <span class="st">&quot;Hello Nuki&quot;</span>];
    br;
  ]</code></pre>
<p>Ce code est parfaitement valide et ne provoque donc aucune erreur. Par contre, si le dernier <code>&lt;span&gt;</code> avait √©t√© : <code>span [div [pcdata &quot;Hello Nuki&quot;]]</code>, une erreur aurait √©t√© lev√©e.</p>
<h3 id="retour-dexp√©rience-sur-la-production-de-html-valide">Retour d'exp√©rience sur la production de HTML valide</h3>
<p>L'exercice est int√©ressant et permet de comprendre le r√¥le des variants polymorphes dans la d√©coration de types, via les types fant√¥mes. C'est une m√©thode de ce genre (pas identique ceci dit, sans aucun doute plus riche) qui est utilis√©e dans <a href="http://ocsigen.org/tyxml/">TyXML</a>, un des composants de <a href="http://ocsigen.org">Ocsigen</a> pour rendre la production de XML invalide absolument impossible (il peut s'utiliser au moyen d'une extension de syntaxe).</p>
<p>Je trouve cette mani√®re de proc√©der assez astucieuse, m√™me si cet article n'en pr√©sente qu'une infime partie. En effet, il faudrait aller plus loin en typant les attributs, etc. Cependant, la vocation de cette section n'est que de montrer un rapide exemple d'utilisation des types fant√¥mes.</p>
<h2 id="requ√™tes-sql-statiquement-typ√©es">Requ√™tes SQL statiquement typ√©es</h2>
<p>Une fois de plus, mon exemple est emprunt√© au cadriciel <a href="http://ocsigen.org">Ocsigen</a>. En effet, dans beaucoup de langages web, lorsque l'on doit effectuer une communication avec une base de donn√©es, il est courant de construire la requ√™te dans une cha√Æne de caract√®res, qui est un moyen expressif de construire du SQL et de l'envoyer au serveur de base de donn√©es, lui d√©l√©gant la v√©rification de la formation de cette derni√®re. C'est une mani√®re de faire peu fiable, qui provoque des erreurs d'ex√©cution de code, ce que le programmeur OCaml aime √©viter.</p>
<p><a href="http://ocsigen.org/macaque/">Macaque</a> est une biblioth√®que permettant de formuler des requ√™tes v√©rifi√©es √† la compilation. Pour cet exemple, je ne rentrerai pas dans les d√©tails (car c'est fort long et d√©passe sans aucun doute mes comp√©tences), mais Macaque s'appuie sur des types fant√¥mes pour d√©corer des types de OCaml avec des informations relatives √† SQL. Pour l'avoir utilis√©, Macaque est tr√®s utile (et agr√©able) et offre le confort de la validation de requ√™tes (syntaxique et logique).</p>
<h2 id="conclusion">Conclusion</h2>
<p>Je terminerai cette br√®ve pr√©sentation en limitant la notion de type fant√¥me √† &quot;un (ou plusieurs labels) donnant des informations d'utilisations compl√©mentaires √† des types&quot;. Cet √©tiquetage permet une v√©rification statique d'un bon usage des donn√©es. Les inconv√©nients sont l'expressivit√© limit√©e et le fait que √ßa introduise parfois des erreurs de types assez lourdes √† lire.</p>
<p>Les types fant√¥mes sont m√™me utilis√©s dans la biblioth√®que standard de OCaml et donc ne sont pas que des <em>features</em> un peu trop particuli√®res.</p>

			</div>
			
			<div class="comment_box">
				<h2>Commentaires</h2>
				  <div id="disqus_thread"></div>
					<script type="text/javascript">
						/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
						var disqus_shortname = 'nukifw'; // required: replace example with your forum shortname
						
						/* * * DON'T EDIT BELOW THIS LINE * * */
						(function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
						})();
					</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			</div>

		</div>
		<div id="header-line"></div>
	</body>
</html>
